name: Deploy

on:
    push:
        branches:
            - 'main'

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Install dependencies
              run: |
                sudo apt update
                sudo apt install meson clang
                sudo apt install libasound2-dev
                sudo apt install musl-dev musl-tools

            - name: Install Rust dependencies
              run: |
                rustup target add x86_64-unknown-linux-musl

            - name: Build C++ project
              run: |
                cd libfakedevice-cpp
                ./autorun.sh

            - name: Build C project
              run: |
                cd libfakedevice-c
                ./autorun.sh

            - name: Build Rust project
              run: |
                cd libfakedevice-rust
                ./autorun.sh --target=x86_64-unknown-linux-musl

            - name: Strip C++ binary
              run: |
                strip ./libfakedevice-cpp/build/fake-firmware-cpp

            - name: Strip Rust binary
              run: |
                strip ./libfakedevice-rust/target/x86_64-unknown-linux-musl/debug/fake-firmware-rust

            - name: Strip C binary
              run: |
                strip ./libfakedevice-c/build/fake-firmware-c

            - name: Create a release
              uses: softprops/action-gh-release@v1
              with:
                tag_name: v0.1.0
                files: |
                    ./libfakedevice-cpp/build/fake-firmware-cpp
                    ./libfakedevice-c/build/fake-firmware-c
                    ./libfakedevice-rust/target/x86_64-unknown-linux-musl/debug/fake-firmware-rust
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
